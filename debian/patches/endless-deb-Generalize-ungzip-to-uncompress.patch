From 51dedf37ac7cc67a0f8e5e92cafe27afe6154992 Mon Sep 17 00:00:00 2001
From: Riku Voipio <riku.voipio@linaro.org>
Date: Thu, 19 Oct 2017 11:59:43 +0300
Subject: [PATCH 1/2] deb: Generalize ungzip to uncompress

In preparation fot xz support
---
 Build/Deb.pm | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

--- a/Build/Deb.pm
+++ b/Build/Deb.pm
@@ -160,8 +160,9 @@ sub parse {
   return $ret;
 }
 
-sub ungzip {
+sub uncompress {
   my $data = shift;
+  my $tool = shift;
   local (*TMP, *TMP2);
   open(TMP, "+>", undef) or die("could not open tmpfile\n");
   syswrite TMP, $data;
@@ -170,13 +171,13 @@ sub ungzip {
   die("fork: $!\n") unless defined $pid;
   if (!$pid) {
     open(STDIN, "<&TMP");
-    exec 'gunzip';
-    die("gunzip: $!\n");
+    exec($tool);
+    die("$tool: $!\n");
   }
   close(TMP);
   $data = '';
   1 while sysread(TMP2, $data, 1024, length($data)) > 0;
-  close(TMP2) || die("gunzip error");
+  close(TMP2) || die("$tool error");
   return $data;
 }
 
@@ -191,6 +192,7 @@ sub debq {
     return ();
   }
   my $data = '';
+  my $decompressor = "gunzip";
   sysread(DEBF, $data, 4096);
   if (length($data) < 8+60) {
     warn("$fn: not a debian package - header too short\n");
@@ -232,10 +234,10 @@ sub debq {
   close DEBF unless ref($fn);
   $data = substr($data, 60, $len);
   my $controlmd5 = Digest::MD5::md5_hex($data);	# our header signature
-  if ($have_zlib) {
+  if ($have_zlib && $decompressor eq "gunzip") {
     $data = Compress::Zlib::memGunzip($data);
   } else {
-    $data = ungzip($data);
+    $data = uncompress($data, $decompressor);
   }
   if (!$data) {
     warn("$fn: corrupt control.tar.gz file\n");
